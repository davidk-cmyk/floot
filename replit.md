# MyPolicyPortal

## Overview
MyPolicyPortal is a comprehensive policy management platform that streamlines policy creation, distribution, and acknowledgment, powered by AI.

## Tech Stack
- **Frontend**: React 19 + Vite + TypeScript
- **Backend**: Hono (Node.js server framework)
- **Database**: PostgreSQL (via Kysely ORM)
- **Runtime**: Node.js 20

## Project Structure
- `/components` - React components (TSX + CSS modules)
- `/endpoints` - API endpoint handlers organized by domain
- `/helpers` - Utility functions and database schema
- `/pages` - Route pages
- `server.ts` - Main server entry point (Hono)
- `index.tsx` - React app entry point
- `vite.config.ts` - Vite configuration

## Environment Configuration
The application uses a combination of Replit Secrets and `env.json`:

### Required (via Replit Secrets)
- `DATABASE_URL` - Automatically mapped to `FLOOT_DATABASE_URL`
- `SESSION_SECRET` - Automatically mapped to `JWT_SECRET`

### AI Integration (via Replit AI Integrations)
- `AI_INTEGRATIONS_ANTHROPIC_API_KEY` - Automatically provided by Replit
- `AI_INTEGRATIONS_ANTHROPIC_BASE_URL` - Automatically provided by Replit
- Uses Claude claude-sonnet-4-5 model for policy generation and AI features
- No API key required - charges billed to Replit credits

### Optional (via env.json)
- `RESEND_API_KEY` - Resend API key for email services

The `loadEnv.js` file prioritizes environment variables over env.json values for security.

## Development

### Running the Application
The application runs on port 5000 and serves both the frontend and backend:
```bash
npm run build  # Build the frontend
tsx server.ts  # Start the server
```

### Workflow
The "Start application" workflow is configured to:
1. Run `tsx server.ts` on port 5000
2. Serve the built frontend from `/dist`
3. Handle API requests at `/_api/*` endpoints

## Database
- PostgreSQL database is available via the `DATABASE_URL` secret
- Schema is defined in `helpers/schema.tsx` (auto-generated by kysely-codegen)
- Database uses Kysely with camelCase mapping - TypeScript uses camelCase/PascalCase, SQL uses snake_case

### Database Schema
The database includes:
- **26 tables**: users, organizations, policies, portals, notifications, sessions, and more
- **1 view**: `unacknowledged_required_policies` - computed view for policy acknowledgment tracking
- **2 triggers**: Auto-create policy versions on insert/update
- **101 indexes**: Performance optimization for all major queries
- **Custom type**: `user_role` enum (admin, approver, editor, user)

## Deployment
Configured for VM deployment with:
- Build command: `npm run build` (builds the frontend to `/dist`)
- Run command: `tsx server.ts` (serves the built frontend and API)
- The application maintains state in server memory
- Port: 5000 (frontend and backend on same server)

Note: The build step is automatically executed during deployment. For local development, run `npm run build` once before starting the server, or the workflow will serve the existing dist folder.

## Recent Changes
- **2024-12-08**: Replaced Google Drive integration with Replit connector
  - Replaced custom Google Picker implementation with Replit's Google Drive integration
  - New file browser UI in FileUploadTab component for selecting files from Google Drive
  - OAuth is now handled automatically by Replit - no hardcoded API keys
  - Created new endpoints: `/_api/google-drive/list` and `/_api/google-drive/download-file`
  - SharePoint integration available but not configured (user dismissed during setup)

- **2024-12-08**: Fixed PDF upload parsing issue
  - Installed libuuid system dependency
  - Fixed pdfjs-dist import for Node.js ESM environment

- **2024-12-08**: Fixed organization registration constraint
  - Changed portal slug unique constraint from global to per-organization
  - Dropped `portals_slug_key` (global unique on slug)
  - Added `portals_organization_slug_unique` (unique on organization_id + slug)
  - This allows each organization to have their own "public" and "internal" portals

- **2024-12-03**: Switched AI provider from OpenAI to Claude
  - Migrated from OpenAI API to Replit AI Integrations (Anthropic/Claude)
  - No API key required - uses Replit's built-in integration
  - Updated all AI endpoints: generate-policy, policy-prompt, suggest-improvements, rewrite-plain-english, suggest-missing-policies
  - Using Claude claude-sonnet-4-5 model with 8192 max tokens

- **2024-12-03**: Database schema import from original deployment
  - Imported exact schema from original database dump including all triggers, constraints, and indexes
  - Created 26 tables, 1 view, 2 triggers, 101 indexes, and user_role enum type
  - All foreign key constraints properly configured with ON DELETE CASCADE where appropriate
  - Verified application runs correctly with new schema

- **2024-12-02**: Initial Replit environment setup
  - Configured Vite to bind to 0.0.0.0:5000 with proper HMR settings for Replit proxy
  - Updated server.ts to bind to 0.0.0.0:5000
  - Created env.json with database and JWT configuration
  - Configured workflow for port 5000 with webview output
  - Set up deployment configuration for VM target
  - Installed dependencies with legacy peer deps flag (React 19 compatibility)
